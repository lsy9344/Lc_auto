## 0) 제품 개요

* **ID:** APP-001
* **목표:** Windows에서 작은 런처 앱으로 동영상 재생, 2개 자동화 실행, 폴더 열기, 예약 경고 팝업을 제공한다.
* **대상 OS:** Windows 10+
* **우선순위 표기:** P0(필수), P1(권장)

---

## 1) 핵심 사용 흐름

### 1.1 앱 시작
1. 앱 실행 → 기본 **항상 위(AlwaysOnTop)** 상태
2. 4개 버튼 표시: **start_photo (촬영 시작)**, **export_files (내보내기)**, **c (배경지 설치 동영상 보기)**, **d (사진 저장 폴더 열기)**

### 1.2 실제 사용자 워크플로우

#### 자동화: 촬영 시작 (start_photo)
1. 사용자가 '촬영 시작' 버튼 클릭
2. 입력 폼 표시: "예약자 성함", "휴대폰 뒤4자리" 텍스트 입력란 + "촬영 시작" 버튼
3. 사용자 입력 후 "촬영 시작" 버튼 클릭
4. **입력값 검증**:
   - "예약자 성함": 비어 있지 않은 문자열 (한글, 영문, 공백 허용)
   - "휴대폰 뒤4자리": 정확히 4자리 숫자 (정규식: `1234`)
   - 검증 실패 시 에러 다이얼로그 표시, 자동화 실행하지 않음
5. **Lightroom Classic 창이 최상위**로 전환
6. 자동화 로직 실행: 입력된 "예약자 성함" + "휴대폰 뒤4자리"를 조합(`{성함}{뒤4자리}`, 예: "홍길동" + "1234" → `홍길동1234`)하여 자동화 중간에 특정 위치에 붙여넣기
   - **최종 포맷**: 문자열 + 숫자 4자리 (공백/구분자 없음)
7. 자동화 완료 후 입력값 폐기 (메모리에서 제거, 다음 실행 시 재입력 필요)
8. 앱이 다시 최상위로 복귀

#### 자동화: 내보내기 (export_files)
1. 사용자가 '내보내기' 버튼 클릭
2. 입력 폼 표시: "예약자 성함", "휴대폰 뒤4자리" 텍스트 입력란 + "내보내기 시작" 버튼
3. 사용자 입력 후 "내보내기 시작" 버튼 클릭
4. **입력값 검증**:
   - "예약자 성함": 비어 있지 않은 문자열 (한글, 영문, 공백 허용)
   - "휴대폰 뒤4자리": 정확히 4자리 숫자 (정규식: `1234`)
   - 검증 실패 시 에러 다이얼로그 표시, 자동화 실행하지 않음
5. **Lightroom Classic 창이 최상위**로 전환
6. 자동화 로직 실행: 입력된 "예약자 성함" + "휴대폰 뒤4자리"를 조합(`{성함}{뒤4자리}`, 예: "홍길동" + "1234" → `홍길동1234`)하여 자동화 중간에 특정 위치에 붙여넣기
   - **최종 포맷**: 문자열 + 숫자 4자리 (공백/구분자 없음)
7. 자동화 완료 후 입력값 폐기 (메모리에서 제거, 다음 실행 시 재입력 필요)
8. 앱이 다시 최상위로 복귀

#### 버튼 c: 배경지 설치 동영상 보기
1. 사용자가 버튼 c 클릭
2. 설정된 동영상 재생 (config 파일 참조)
3. 앱은 최상위 상태 유지

#### 버튼 d: 사진 저장 폴더 열기
1. 사용자가 버튼 d 클릭
2. Windows 탐색기로 설정된 폴더 열기 (config 파일 참조)
3. 앱은 최상위 상태 유지

### 1.3 예약 경고 팝업
- 설정된 시간 도래 시 **모달 팝업** 표시
- 사용자가 OK 버튼 클릭 시 닫힘

---

## 2) 기능 요구사항 (Functional Requirements)

### FR-01 Always On Top (P0)

* **설명:** 앱 메인 윈도우는 기본적으로 AlwaysOnTop 유지.
* **상태 전이:**
  * 초기화 시 `TopMost=true`.
  * FR-02/03 수행 시 Lightroom Classic 창이 `TopMost` 우선권 획득.
  * 자동화 완료/포커스 아웃 시 500ms 내 앱이 `TopMost` 복구.
* **오류 처리:** 복구 실패 시 1초 간격 최대 3회 재시도.

### FR-02 자동화: 촬영 시작 (start_photo) (P0)

* **입력:**
  - UI 입력 폼: "예약자 성함", "휴대폰 뒤4자리"
  - 설정: `config.automation.start_photo.featureId`
* **입력값 검증 규칙:**
  - **"예약자 성함"**: 비어 있지 않은 문자열 (한글, 영문, 공백 허용)
  - **"휴대폰 뒤4자리"**: 정확히 4자리 숫자 (정규식: `1234`)
  - 검증 실패 시 에러 다이얼로그 표시, 자동화 실행하지 않음
* **입력값 조합 포맷:** `{성함}{뒤4자리}` (공백/구분자 없음)
  - 예시: "홍길동" + "1234" → `홍길동1234`
* **동작:** (§1.2 워크플로우 참조)
* **출력:** `result: success|error`, `message?`, `elapsedMs`(옵션)
* **제약:**
  - UI 요소 탐색/상호작용 타임아웃: 시도당 30초
  - 재시도 정책: 초기 시도 1회 + 재시도 최대 2회 = **총 3회 시도**
  - 총 최대 소요 시간: ~90초
* **기술:** FlaUI 기반 Lightroom Classic UI 자동화

### FR-03 자동화: 내보내기 (export_files) (P0)

* **내용:** FR-02와 동일 (§1.2 워크플로우 참조)
* **설정:** `config.automation.export_files.featureId` 사용
* **UI 버튼:** "내보내기 시작"

### FR-04 동영상 재생 (c - 배경지 설치 동영상 보기) (P0)

* **입력:** `config.media.videoPath`
* **동작:** 기본 플레이어 또는 지정 플레이어로 재생(선택: `config.media.playerPath`).
* **성공 조건:** OS에 미디어 핸들러 등록 또는 지정 플레이어 존재.

### FR-05 폴더 열기 (d - 사진 저장 폴더 열기) (P0)

* **입력:** `config.paths.targetFolder`
* **동작:** Windows 탐색기로 해당 폴더 오픈.
* **오류:** 경로 없음 → 경고 다이얼로그 표시 (폴더 생성하지 않음).

### FR-06 예약 경고 팝업 (P0)

* **입력:** `config.alerts[]` (시/분, 메시지, 반복 여부)
* **동작:** 로컬 시간 기준 스케줄에 팝업(모달). 사용자가 확인(OK) 클릭 시 닫힘.
* **반복:** `repeat: daily | once` (기본: daily).
* **지연 허용:** 트리거 ±1초.

---

## 3) 비기능 요구사항 (NFR)

* **NFR-01 성능 (P0):** 대기시 CPU < 3%, RSS < 120MB.
* **NFR-02 안정성 (P0):** 자동화 시나리오 실패율 < 1% (재시도 1회).
* **NFR-03 배포 (P0):** 단일 exe 패키징 가능.
* **NFR-04 로그 (P0/P1):** INFO/ERROR 로테이션(최소 7일 보관).
* **NFR-05 권한 (P0):** 관리자 권한 불필요(기본). 필요 시 사유 로그.

---

## 4) 구성(설정) 스키마

설정 파일은 `config/config.json`에 위치하며, JSON Schema 표준을 따릅니다.

**스키마 정의:** `config/config.schema.json` 참조

**예시 설정 파일:**
```json
{
  "media": {
    "videoPath": "C:\\Media\\background_installation.mp4",
    "playerPath": ""
  },
  "automation": {
    "start_photo": {
      "featureId": "Lightroom.StartPhotoSession",
      "description": "촬영 시작 자동화"
    },
    "export_files": {
      "featureId": "Lightroom.ExportPhotos",
      "description": "내보내기 자동화"
    },
    "timeoutSec": 30
  },
  "paths": {
    "targetFolder": "C:\\Photos\\Output"
  },
  "alerts": [
    { "time": "09:00", "message": "오전 촬영 시작", "repeat": "daily" },
    { "time": "14:00", "message": "오후 촬영 시작", "repeat": "daily" }
  ],
  "ui": {
    "alwaysOnTop": true,
    "theme": "auto"
  }
}
```

**참고:**
- `inputValues`(예약자 성함, 휴대폰 뒤4자리)는 config에 저장하지 않음 (사용자가 매번 UI 폼에 입력)
- `featureId`는 실제 Lightroom Classic UI 요소와 매핑되어야 함 (FeatureSelectorRegistry에서 관리)
- 설정 검증 및 필드 설명은 `config.schema.json` 참조

---

## 5) 트리거 & 입력/출력 요약

| 트리거 | 입력 | 출력 |
| --- | --- | --- |
| 앱 시작 | 설정 JSON | 메인 윈도우 TopMost |
| 버튼: start_photo | UI 폼(예약자 성함, 휴대폰 뒤4자리) + `automation.start_photo` | result, message |
| 버튼: export_files | UI 폼(예약자 성함, 휴대폰 뒤4자리) + `automation.export_files` | result, message |
| 버튼 c | `videoPath`, `playerPath?` | 미디어 플레이어 프로세스 |
| 버튼 d | `targetFolder` | 파일 탐색기 프로세스 |
| 알림 스케줄 | `alerts[]` | 모달 팝업(메시지) |

---

## 6) 우선순위/범위

* **P0(이번 릴리스):**
  - FR-01 ~ FR-06
  - NFR-01(성능), NFR-02(안정성), NFR-03(배포), NFR-05(권한)
  - NFR-04(기본 파일 로깅: 7일 보관 롤링 정책)
* **P1(차기):**
  - NFR-04(고급 기능: 로그 뷰어, 원격 전송 등)
  - 트레이 아이콘
  - 다국어 지원

---

## 7) 엣지 케이스 & 규칙

1.  **동시 실행 충돌 (FR-02, FR-03):** `start_photo`와 `export_files`를 연속 클릭 → 첫 번째 자동화가 완료될 때까지 두 번째 자동화는 대기 또는 차단.
2.  **UI 요소 식별 실패 (FR-02, FR-03):** 대상 UI 요소가 없거나 비활성 → 에러 다이얼로그 표시, 로그 저장.
3.  **구성 미존재 (FR-02, FR-03, FR-04, FR-05):** `videoPath`/`targetFolder`/`automation` 정의가 없으면 경고 다이얼로그 표시 후 해당 기능 비활성화.
4.  **알림 중복 (FR-06):** 같은 시각 다중 알림 또는 기존 알림 표시 중 새 알림 발생 → 기존 모달의 메시지만 최신 내용으로 업데이트(중복 모달 생성 안 함).
5.  **절전/절전복귀 (FR-06):** 잠자기 복귀 시 지난 알림은 스킵, 다음 스케줄부터 재개.
6.  **Lightroom 비정상 종료 (FR-02, FR-03):** 자동화 중 Lightroom이 최소화/종료되면 즉시 자동화 실패 처리, 앱 포커스 복원, 경고 다이얼로그 표시.

---

## 8) 수용 기준 (Acceptance Criteria)

* **AC-01:** 앱 실행 시 즉시 TopMost. 자동화(FR-02/03) 수행 중 Lightroom Classic 창이 최상위이며 자동화 완료/포커스아웃 후 앱이 500ms 내 TopMost 복귀.
* **AC-02:** `start_photo`/`export_files` 버튼 클릭 시 입력 폼이 표시되고, 사용자가 값 입력 후 확인 버튼을 누르면 설정된 자동화가 수행된다. 입력값은 자동화 완료 후 폐기된다.
* **AC-03:** c 클릭 시 지정 동영상이 재생된다(기본/지정 플레이어). `playerPath`가 유효하지 않으면 경고 다이얼로그 표시하고 재생하지 않음.
* **AC-04:** 자동화 수행 중 UI 요소 미발견/실패 시 사용자에게 에러 다이얼로그가 표시되고 로그에 상세 정보 기록.
* **AC-05:** d 클릭 시 지정 폴더가 탐색기에서 열린다. 폴더가 없으면 경고 다이얼로그 표시.
* **AC-06:** 알림 시간(±1s 허용)에 모달 팝업이 뜨고 OK 시 닫힌다. 알림 표시 중 새 알림 발생 시 기존 모달의 메시지가 최신 내용으로 업데이트된다.
* **AC-07:** 관리자 권한 없이 설치·실행 가능하다.

---

## 9) 구현 힌트(플랫폼 중립, LLM용)

* **TopMost 제어:** 앱 `TopMost=true`; 자동화 전 Lightroom Classic 창을 `FindWindow/SetForegroundWindow` 또는 UI Automation으로 포커스. 완료 감지: 시나리오 종료 콜백 또는 타임아웃.
* **FlaUI 자동화:** UI 요소 탐색/클릭/입력 + 타임아웃/재시도.
* **알림 스케줄러:** 로컬 타이머 + 크론 유사 반복(daily). 절전 복귀 시 현재 시각 기준 리셋.
* **구성 로드:** 앱 시작 시 JSON 로드, 변경 시 핫리로드(옵션).

---

## 10) 용어

* **TopMost:** 다른 모든 일반 창 위에 배치되는 윈도우 z-order 플래그.
* **자동화 대상:** Lightroom Classic 내 특정 기능(UI 요소).

---

## 11) 기술 스택 & 구현 방향 (요약)

* **플랫폼:** Windows 10/11
* **프레임워크:** C# WPF (.NET 8)
* **UI 테마:** ModernWpf (대안: MaterialDesignInXaml)
* **자동화:** FlaUI (UIA3)
* **아키텍처:** MVVM + Service Layer + Config-Driven
* **배포:** 단일 exe(Self-contained, SingleFile), 무설치
* **로그/진단:** Serilog + Rolling File
* **테스트:** FlaUI E2E + xUnit 단위테스트
* **CI/CD:** GitHub Actions (빌드·서명·릴리스)
